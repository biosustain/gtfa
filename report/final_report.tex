%! Author = jason
%! Date = 27/10/21

% Template for PLoS
% Version 3.5 March 2018
%
% % % % % % % % % % % % % % % % % % % % % %
%
% -- IMPORTANT NOTE
%
% This template contains comments intended
% to minimize problems and delays during our production
% process. Please follow the template instructions
% whenever possible.
%
% % % % % % % % % % % % % % % % % % % % % % %
%
% Once your paper is accepted for publication,
% PLEASE REMOVE ALL TRACKED CHANGES in this file
% and leave only the final text of your manuscript.
% PLOS recommends the use of latexdiff to track changes during review, as this will help to maintain a clean tex file.
% Visit https://www.ctan.org/pkg/latexdiff?lang=en for info or contact us at latex@plos.org.
%
%
% There are no restrictions on package use within the LaTeX files except that
% no packages listed in the template may be deleted.
%
% Please do not include colors or graphics in the text.
%
% The manuscript LaTeX source should be contained within a single file (do not use \input, \externaldocument, or similar commands).
%
% % % % % % % % % % % % % % % % % % % % % % %
%
% -- FIGURES AND TABLES
%
% Please include tables/figure captions directly after the paragraph where they are first cited in the text.
%
% DO NOT INCLUDE GRAPHICS IN YOUR MANUSCRIPT
% - Figures should be uploaded separately from your manuscript file.
% - Figures generated using LaTeX should be extracted and removed from the PDF before submission.
% - Figures containing multiple panels/subfigures must be combined into one image file before submission.
% For figure citations, please use "Fig" instead of "Figure".
% See http://journals.plos.org/plosone/s/figures for PLOS figure guidelines.
%
% Tables should be cell-based and may not contain:
% - spacing/line breaks within cells to alter layout or alignment
% - do not nest tabular environments (no tabular environments within tabular environments)
% - no graphics or colored text (cell background color/shading OK)
% See http://journals.plos.org/plosone/s/tables for table guidelines.
%
% For tables that exceed the width of the text column, use the adjustwidth environment as illustrated in the example table in text below.
%
% % % % % % % % % % % % % % % % % % % % % % % %
%
% -- EQUATIONS, MATH SYMBOLS, SUBSCRIPTS, AND SUPERSCRIPTS
%
% IMPORTANT
% Below are a few tips to help format your equations and other special characters according to our specifications. For more tips to help reduce the possibility of formatting errors during conversion, please see our LaTeX guidelines at http://journals.plos.org/plosone/s/latex
%
% For inline equations, please be sure to include all portions of an equation in the math environment.  For example, x$^2$ is incorrect; this should be formatted as $x^2$ (or $\mathrm{x}^2$ if the romanized font is desired).
%
% Do not include text that is not math in the math environment. For example, CO2 should be written as CO\textsubscript{2} instead of CO$_2$.
%
% Please add line breaks to long display equations when possible in order to fit size of the column.
%
% For inline equations, please do not include punctuation (commas, etc) within the math environment unless this is part of the equation.
%
% When adding superscript or subscripts outside of brackets/braces, please group using {}.  For example, change "[U(D,E,\gamma)]^2" to "{[U(D,E,\gamma)]}^2".
%
% Do not use \cal for caligraphic font.  Instead, use \mathcal{}
%
% % % % % % % % % % % % % % % % % % % % % % % %
%
% Please contact latex@plos.org with any questions.
%
% % % % % % % % % % % % % % % % % % % % % % % %

\documentclass[10pt,letterpaper]{article}
\usepackage[top=0.85in,left=2.75in,footskip=0.75in]{geometry}

% amsmath and amssymb packages, useful for mathematical formulas and symbols
\usepackage{amsmath,amssymb}

% Use adjustwidth environment to exceed column width (see example table in text)
\usepackage{changepage}

% Use Unicode characters when possible
\usepackage[utf8x]{inputenc}

% textcomp package and marvosym package for additional characters
\usepackage{textcomp,marvosym}
\usepackage{gensymb}

% cite package, to clean up citations in the main text. Do not remove.
\usepackage{cite}

% Use nameref to cite supporting information files (see Supporting Information section for more info)
\usepackage{nameref,hyperref}

% line numbers
\usepackage[right]{lineno}

% ligatures disabled
\usepackage{microtype}
\DisableLigatures[f]{encoding = *, family = * }

% color can be used to apply background shading to table cells only
\usepackage[table]{xcolor}

% array package and thick rules for tables
\usepackage{array}

% create "+" rule type for thick vertical lines
\newcolumntype{+}{!{\vrule width 2pt}}

% create \thickcline for thick horizontal lines of variable length
\newlength\savedwidth
\newcommand\thickcline[1]{%
  \noalign{\global\savedwidth\arrayrulewidth\global\arrayrulewidth 2pt}%
  \cline{#1}%
  \noalign{\vskip\arrayrulewidth}%
  \noalign{\global\arrayrulewidth\savedwidth}%
}

% \thickhline command for thick horizontal lines that span the table
\newcommand\thickhline{\noalign{\global\savedwidth\arrayrulewidth\global\arrayrulewidth 2pt}%
\hline
\noalign{\global\arrayrulewidth\savedwidth}}


% Remove comment for double spacing
%\usepackage{setspace}
%\doublespacing

% Text layout
\raggedright
\setlength{\parindent}{0.5cm}
\textwidth 5.25in
\textheight 8.75in

% Bold the 'Figure #' in the caption and separate it from the title/caption with a period
% Captions will be left justified
\usepackage[aboveskip=1pt,labelfont=bf,labelsep=period,justification=raggedright,singlelinecheck=off]{caption}
\renewcommand{\figurename}{Fig}

% Use the PLoS provided BiBTeX style
\bibliographystyle{plos2015}

% Remove brackets from numbering in List of References
\makeatletter
\renewcommand{\@biblabel}[1]{\quad#1.}
\makeatother



% Header and Footer with logo
\usepackage{lastpage,fancyhdr,graphicx}
\usepackage{epstopdf}
\usepackage{amsfonts}
%\pagestyle{myheadings}
\pagestyle{fancy}
\fancyhf{}
%\setlength{\headheight}{27.023pt}
%\lhead{\includegraphics[width=2.0in]{PLOS-submission.eps}}
\rfoot{\thepage/\pageref{LastPage}}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrule}{\hrule height 2pt \vspace{2mm}}
\fancyheadoffset[L]{2.25in}
\fancyfootoffset[L]{2.25in}
\lfoot{\today}

%% Include all macros below

%\newcommand{\lorem}{{\bf LOREM}}
%\newcommand{\ipsum}{{\bf IPSUM}}


\newcommand{\dgf}{\Delta_fG}
\newcommand{\sdgf}{\Delta_fG^{\degree}}
\newcommand{\dgr}{\Delta_rG}
\newcommand{\sdgr}{\Delta_rG^{\degree}}
\newcommand{\bdgf}{\mathbf{\dgf}}
\newcommand{\bsdgf}{\mathbf{\sdgf}}
\newcommand{\bdgr}{\mathbf{\dgr}}
\newcommand{\bsdgr}{\mathbf{\sdgr}}
\newcommand{\be}{\mathbf{e}}
\newcommand{\bc}{\mathbf{c}}
\newcommand{\bb}{\mathbf{b}}
\newcommand{\bv}{\mathbf{v}}
\newcommand{\bbe}{\mathbf{be}}




%% END MACROS SECTION


\begin{document}

\vspace*{0.2in}

% Title must be 250 characters or less.
\begin{flushleft}
{\Large
\textbf\newline{GTFA: Genrative Thermodynamic Flux Analysis} % Please use "sentence case" for title and headings (capitalize only the first word in a title (or heading), the first word in a subtitle (or subheading), and any proper nouns).
}
\newline
% Insert author names, affiliations and corresponding author email (do not include titles, positions, or degrees).
\\
Jason Jooste\textsuperscript{1},
Teddy Groves\textsuperscript{2},
Lars Nielsen\textsuperscript{2,3},
%Name4 Surname\textsuperscript{2},
%Name5 Surname\textsuperscript{2\ddag},
%Name6 Surname\textsuperscript{2\ddag},
%Name7 Surname\textsuperscript{1,2,3*},
%with the Lorem Ipsum Consortium\textsuperscript{\textpilcrow}
\\
\bigskip
\textbf{1} Ludwig Maximlian's Universität München, Munich, Bavaria, Germany
\\
\textbf{2} Novo Nordisk Foundation Center for Biosustainability, Technical University of Denmark, Kgs. Lyngby, Denmark
%\\
\textbf{3} Australian Institute for Bioengineering and Nanotechnology, University of Queensland, Brisbane, Queensland, Australia
%\\
\bigskip

% Insert additional author notes using the symbols described below. Insert symbol callouts after author names as necessary.
%
% Remove or comment out the author notes below if they aren't used.
%
% Primary Equal Contribution Note
%\Yinyang These authors contributed equally to this work.

% Additional Equal Contribution Note
% Also use this double-dagger symbol for special authorship notes, such as senior authorship.
%\ddag These authors also contributed equally to this work.

% Current address notes
%\textcurrency Current Address: Dept/Program/Center, Institution Name, City, State, Country % change symbol to "\textcurrency a" if more than one current address note
% \textcurrency b Insert second current address
% \textcurrency c Insert third current address

% Deceased author note
%\dag Deceased

% Group/Consortium Author Note
%\textpilcrow Membership list can be found in the Acknowledgments section.

% Use the asterisk to denote corresponding authorship and provide email address in note below.
%* correspondingauthor@institute.edu

\end{flushleft}
% Please keep the abstract below 300 words
\section*{Abstract}


% Please keep the Author Summary between 150 and 200 words
% Use first person. PLOS ONE authors please skip this step.
% Author Summary not valid for PLOS ONE submissions.
\section*{Author summary}

%Aim to highlight where your work fits within a broader context; present the significance or possible implications of
%your work simply and objectively; and avoid the use of acronyms and complex terminology wherever possible. The goal is
%to make your findings accessible to a wide audience that includes both scientists and non-scientists.

\linenumbers

% Use "Eq" instead of "Equation" for equation citations.
\section*{Introduction}

% TODO: Longer intro to the field in general?
Modelling of feasible intracellular fluxes has long been a key task in metabolic engineering.
If little data is available, the space of valid fluxes can be relatively large, limited only by fundamental reaction stoichiometry and mass-balance laws:
\[
    \label{eq:steady_state}
    0 = S\cdot \mathbf{v}
\]
with $S \in \mathbb{Z}^{m\times r}$ representing the stoichiometric matrix, which contains the stoichiometric coefficients of the $m$ metabolites in the $r$ reactions in the metabolic network and $\mathbf{v} \in \mathbb{R}^r$ representing the fluxes of reactions $1,\dots,r$.
If more data is available, this space can be further constrained by known kinetics and regulatory interactions of metabolic enzymes.
A single most-parsimonious solution can then be obtained, with parsiomny determined by maximising biomass production, nearness to measured data or other objective functions {TODO: Others?}.
However, it is a difficult task for these simple measures of parsimony to define true intracellular conditions from such large spaces of viable fluxes.
An alternative is to characterise the entire space of vaiable fluxes, usually with some form of sampling. {TODO: Further references here}

Methods 1,2 {TODO: Research these} were developed to sample uniformly from the space of steady-state fluxes.
Saa {TODO: Citation} extended these methods to exclude loops from the flux space, which are known to violate the 2nd law of thermodynamics.
Alternatively, one can simply include thermodynamic constraints which addresses the problem of loops while excluding further fluxes that violate thermodynamics.
In this case, for all reacitons, the Gibbs' energy of reaction ($\dgr$) must be less than 0.
In practice, the $\dgr$ of reaction $i$ is calculated as the sum of the Gibbs energy of reaction under standard conditions ($\sdgr$) and the scaled logarithm of products over reactants (\ref{eq:dgr})
\begin{align}
    \dgr_i &= \sdgr_i + RT\ln \frac{P}{R} \label{eq:dgr}
\end{align}
where $R$ is the gas constant, $T$ is the temperature and $P$ and $R$ are the concentrations of the reaction's products and reactants respectively.
Because the Gibbs energy of a reaction is a state function, the $\dgr$ and $\sdgr$ of a reaction are equivalent to the Gibbs energy of formation ($\dgf$) and standard Gibbs energy of formation ($\sdgf$) respectively of all reaction substrates, when scaled by their stoichiometries.
That is,
\[
    \sdgr_i = s_i \cdot \sdgf_i
\]
where $s_i \in \mathbb{Z}^{m_i}$ are the stoichiometries and $\sdgf \in \mathbb{R}^{m_i}$ are the standard formations energies of metabolites $1,\dots,m_i$ involved in reaction $i$.

For a set of reactions $1,\dots,r$ ($\bdgr \in \mathbb{R^r}$), this can also be written in matrix form as
\begin{align}
        \bdgr &= \bsdgr + RT \cdot S^{T}\ln{\mathbf{c}} \label{eq:dgr_vec}\\
              &= RT \cdot S^T (\sdgf + RT \ln{\mathbf{c}}) \label{eq:dgr_sdgf_vec}
\end{align}
where $\mathbf{c} \in \mathbb{R}_{+}^m$ is the concentration of all metabolites $1,\dots,m$ in $S$.
Eq~\ref{eq:dgr_vec} shows the relation between the $\dgr$ and $\sdgr$ and Eq~\ref{eq:dgr_sdgf_vec} shows how the same can be calculated with the $\sdgf$.
This formulation also nicely highlights the fact that $\dgr$, $\bsdgr$ and $\ln{\mathbf{c}}$ are linearly related. % TODO: This is the wrong statement to be making
As these values are estimated, another benefit of Eq~\ref{eq:dgr_sdgf_vec} becomes clear, namely that all combinations of $\sdgf$ produce a system that is thermodynamically consistent.
An arbitrarily chosen set of $\sdgr$ does not satisfy this property (see~\cite{noor_2013_equilibrator} for a more thorough description of this effect).

% A more natural way to incorporate this probabilistic information would be to sample parameter sets accoring to their
% likelihood. Any optimisation after this point can be by selecting the best one but balancing the likelihood of it
% being present.

Both $\mathbf{c}$ and $\sdgf$ can not be known for certain and need to be estimated, which creates a degree of uncertainty about their true values.
To account for this uncertainty, some margin of error needs to be included to ensure that the true intracellular conditions can be represented.
TMFA {TODO: Etc} define this margin of error for $\sdgr$ and metabolite concentrations by constraining them individually to fall within the 95\% confidence interval.
% TODO: Whole paragraph on the multivariate approach? It's kinda relevant.
~\cite{multiTFA} and~\cite{PTA} improve upon this approach by constraining these values to a 95\% confidence interval of their joint probability, significantly tightening the bounds on possible values.
However, both of these methods discard useful probabistic information about these parameters, effectively treating all values within the confidence interval as equally likely.
~\cite{PTA} {TODO: The exact method} addresses this problem by sampling from the space of valid thermodynamic orthants, i.e. flux directions, with the probabilty of each orthant determined by the probability of $\sdgr$ and metabolite concentrations within it.
Unfortunately, this method still restricts the space of valid concentrations and $\sdgr$ to the 95\% confidence interval, although, to the authors' knowledge, this is not necessary.
Additionally, the hit-and-run sampling method described in~\cite{PTA} requires multiple linear programming evaluations per sample, to ensure that samples satisfy steady state (Eq~\ref{eq:steady_state}), which can inhibit computational performance.

In this work, I present an alternative approach to defining and sampling from the space of fluxes that satisfy both steady-state and thermodynamic constraints.
Generative Thermodynamic Flux Analysis (GTFA) is a method for sampling thermodynamically valid fluxes with respect to the probability that these fluxes match measured metabolite concentrations and standard formation energies.
We represent fluxes as a function of their $\dgr$ multiplied by a scaling factor and separate the network into a set of "fixed" and "free" fluxes.
This results in a parameter space where all combinations of parameters satisfy mass balance and thermodynamic constraints, as opposed to~\cite{PTA}, where large portions of the $\dgr$ parameter space are invalid and must be avoided.
Furthermore, GTFA allows the inclusion of metabolomics, proteomics and fluxomics data.
The final output of GTFA is then a set thermodynamically-valid fluxes, which respects the probability of each of these varied data sources.

% TODO: Maybe some examples? Slower explanation of how there is probabilistic information attached to all of these measurements?

\section*{Materials and methods}

\subsection{Model formulation}
GTFA unifies metabolomics, fluxomics and enzyme proteomics data of a metabolic network in a bayesian generative statistical model.
That is, all measurements are assumed to be subject to measurement error and have latent counterparts in the model that represent the true parameter values.
In the end, this defines a model that is able to generate measured data.
Structurally, fluxes and thermodynamic data are forced to satisfy both steady state~\ref{eq:steady_state} and thermodynamics.

This section will describe the statistical model used in GTFA.
As the model is quite complex, we will progressively increase complexity, starting with a simple model and progressively adding complexity until we reach the final model that was applied in the analyses.

% TODO: Give the models names??
% TODO: Define be as b x e
A naive first description of the model defines the fluxes as a function of the $\dgr$ scaled by enzyme concentrations and the scaling factor $b$, for a single condition.
Firstly, the likelihood function describes the densities of measured data for a given parameter configuration.
The fluxes $\bv$ are a function of the free parameters of the system $\bsdgf$, $\be$, $\bb$ and $\bc$:
\begin{align}
    \bv &= \bdgr \odot \be \odot \bb \\
        &= S^T (\bsdgr + RT\ln{\bc}) \odot \be \odot \bb \\
\end{align}
.
Measurement densities are described as follows:
% TODO: The notation here is a little lax. How can we do it nicely showing that this is conditional on the params?
\begin{align*}
    \mathbf{y_{e}} ~ LN(\ln{\be}, \Sigma_{me}) \\
    \mathbf{y_{c}} ~ LN(\ln{\bc}, \Sigma_{mc}) \\
    \mathbf{y_{v}} ~ N(\bv, \Sigma_{mv}) \\
\end{align*}
where $\Sigma_{me}$, $\Sigma_{mc}$ and $\Sigma{mv}$ are the covariance matrices of the respective measurement errors.
As the measurement errors are assumed to be independent, these covariance matrices are diagonal and thus uniquely defined by their traces $\mathbf{\sigma_{be}}$, $\mathbf{\sigma_{bc}}$, $\mathbf{\sigma_{bv}}$.

The priors are defined as follows:
\begin{align*}
    \be ~ LN(\mathbf{\mu_e}, \Sigma_e) \\
    \bb ~ LN(\mathbf{\mu_b}, \Sigma_b) \\
    \bc ~ LN(\mathbf{\mu_c}, \Sigma_c) \\
    \bv ~ N(\mathbf{\mu_v}, \Sigma_v) \\
    \bsdgf ~ N(\mathbf{\mu_{f}}, \Sigma_{f}) \\
\end{align*}
where $\mathbf{\mu_e}$, $\mathbf{\mu_c}$, $\mathbf{\mu_v}$, $\mathbf{\mu_b}$ and $\mathbf{\mu_f}$ are the means of the prior distributions and $\Sigma_e$,$\Sigma_b$, $\Sigma_c$,$\Sigma_v$, $\Sigma_f$ are the covariance matrices of the priors distributions.
The covariance matrices $\Sigma_e$, $\Sigma_b$, $\Sigma_c$ and $\Sigma_v$ assume independence between the individual entries with traces of $\mathbf{\sigma_e}$, $\mathbf{\sigma_b}$, $\mathbf{\sigma_c}$ and $\mathbf{\sigma_v}$.
For priors on the enzyme and metabolite concentrations we apply the same method as~\cite{PTA} and fit a normal distribution to all conditions in the dataset. %TODO: Actually do this and put the values here
% TODO: Do we have priors on v? If so, how? We could also use the fluxomics data
Defining a prior for $b$ is more difficult, as there is little prior information on such a quantity and it is expected to vary greatly across reactions.
% TODO: Mention Lars' thing here?
We somewhat arbitrarily used a lognormal distribution with a mean of $x$ and a sd of $y$. %TODO, what are the actual values?
% TOdo: Refer to actual analysis here.
Defining a prior for $\bsdgf$ was more complex process as it relied on estimates provided by equilibrator~\cite{noor_2013_equilibrator}.
This is described more thoroughly in Section~\ref{sec:sdgf_estimation}.
\begin{align}
    \bv &= \bdgr \odot \be \odot \bb \\
        &= S^T (\bsdgr + RT\ln{\bc}) \odot \be \odot \bb \\
\end{align}
.
Measurement densities are described as follows:
% TODO: The notation here is a little lax. How can we do it nicely showing that this is conditional on the params?
\begin{align*}
    \mathbf{y_{e}} ~ LN(\ln{\be}, \Sigma_{me}) \\
    \mathbf{y_{c}} ~ LN(\ln{\bc}, \Sigma_{mc}) \\
    \mathbf{y_{v}} ~ N(\bv, \Sigma_{mv}) \\
\end{align*}
where $\Sigma_{me}$, $\Sigma_{mc}$ and $\Sigma{mv}$ are the covariance matrices of the respective measurement errors.
As the measurement errors are assumed to be independent, these covariance matrices are diagonal and thus uniquely defined by their traces $\mathbf{\sigma_{be}}$, $\mathbf{\sigma_{bc}}$, $\mathbf{\sigma_{bv}}$.

The priors are defined as follows:
\begin{align*}
    \be ~ LN(\mathbf{\mu_e}, \Sigma_e) \\
    \bb ~ LN(\mathbf{\mu_b}, \Sigma_b) \\
    \bc ~ LN(\mathbf{\mu_c}, \Sigma_c) \\
    \bsdgf ~ N(\mathbf{\mu_{f}}, \Sigma_{f}) \\
\end{align*}

% TODO: Other kinds of excluded reactions might need to be mentioned here
% TODO: Have numbered models?
\subsubsection{Exchange reactions}
The first adaption to the model is the inclusion of exchange reactions.
Material needs to enter and exit the model, which is represented by one-sided "exchange" reactions that bring individual metabolites through the system boundaries.
These reactions need to satisfy mass balance, but not thermodynamic constraints.
In practice, this requires the flux vector $\bv$ and the stoichiometric matrix $S$ each be separated into two parts.
We represent the first $1,\dots,p$ columns of $S$ and elements of $\bv$ as $S_\Pi$ and $\bv_\Pi$ as those corresponding to the $p$ exchange reactions in the network.
This leaves the remaining $1,\dots,g$ columns of $S$ and elements of $\bv$ as $S_\Gamma$ and $\bv_{Gamma}$ to represent the $g$ internal reactions in the network with $g+p=r$.
Because there is no meaningful notion of thermodynamics associated with these reactions, they cannot be represented in the same manner as the previous model.
Accordingly, the vectors $\be$ and $\bb$ now only have $g$ elements and $\bdgr_{\Gamma} = S\cdot \bdgf$ refers to the Gibbs energy of internal reactions.
The model then defines internal fluxes as before
\begin{align}
    \bv_\Gamma &= \bdgr_{\Gamma} \odot \be \odot \bb \\
        &= S_{\Gamma}^T (\bsdgf + RT\ln{\bc}) \odot \be \odot \bb \\
\end{align}
with a normal prior on the exchange fluxes, which are now free parameters
\begin{align*}
    \bv_{\Pi} ~ N(\mathbf{\mu_{v_{\Pi}}}, \Sigma_{v_{\Pi}}) \\
\end{align*}
This formulation highlights the fact that, with exchange fluxes allowed to vary freely and internal fluxes dependent upon other parameters, there is no guarantee that the steady-state condition holds.
In fact, it is impossible for the constraints to hold, which will be addressed in the next section.

\subsubsection{Parameter fixing}
% TODO: Include here what to do with dependent rows of the s matrix as well. What did I do again?
Equation~\ref{eq:steady_state} effectively removes $m$ degrees of freedom from the system by requiring mass balance of metabolites.
To ensure that all parameter configurations are valid, these degrees of freedom need to be removed from the system.
Often a non-linear solver will be applied to determine a set of fixed parameters that satisfy the given constraints from the parameters that are free to vary. %TODO: Reference for this? Can I reference MAUD?
Luckily, because of the aforementioned linear dependence between $v$, $\bsdgf$ and $\ln{\bc}$, the fixed parameters can easily be determined as a linear combination of free parameters.
\\
If we rearrange these linear relations into a single matrix, the process of solving for fixed parameters is greatly simplified.
For this purpose we require a number of definitions:
\begin{align}
    S_v = \begin{bmatrix}
             I^p & \mathbf{0} \\
             \mathbf{0} & S_{\Gamma}^T \cdot \bbe\\
          \end{bmatrix} \\
    x = \begin{bmatrix}
            \bv_{\Pi} \\
            \bsdgf + RT\ln{\bc}\\ % TODO: Should we just notate these as formation energies?
        \end{bmatrix} \\
    S_m = S \cdot S_v\\
\end{align}
with $x \in \mathbb{R}^{m+p}$ being a vector of exchange reactions and formation energies, $S_v \in \mathbb{R}^{r \times m+p}$
 the matrix that transforms this vector to a vector of fluxes and $S_m \in \mathbb{R}^{m \times m+p}$ the matrix that
 transforms $x$ to the change in metabolite concentrations $d\bc/dt$, which is 0 under steady state.

%TODO: Think about the exact sizes of everything here. Will have something to do with the rank of the matrix
With these definitions in place, $x$ can be split into two parts $x^{fi} \in \mathbb{R}^{ra(S_m)}$ and $x^{fr}\in \mathbb{R}^{m+p-ra(S_m)}$ that correspond to the basic and free variables of $S_m$.
% TODO: We need a reference for the above
% TODO: Should we be more precise here? It's probably not necessary
The values of the free varaibles can thus be determined given a set of proposed free variables
\begin{align}
    0 &= S_m\cdot x\\
    -S_m^{fr}\cdot x^{fr} &= S_m^{fi}\cdot  x^{fi}\\
    x^{fi} &= S_m^{fi}^{-1} \cdot -(S_m^{fr}\cdot x^{fr})\\
\end{align}
where $S_m^{fi}$ and $S_m^{fr}$ are matrices composed of the pivot and non-pivot columns of $S_m$ respectively.
In practice, $x^{fi}$ is solved for instead of using the $S_m^{fi}^{-1}$ due to numerical issues.
This separation into fixed and free fluxes can be extended to the components of $x$, with $\bc^{fi}$, $\bc^{fr}$, $\bv_\Pi^{fi}$ and $\bv_\Pi^{fr}$ corresponding to the fixed and free metabolite concentrations and exchange fluxes respectively.
In concrete terms, this means that the model proposes a set of free fluxes and this allows the determination of the rest of the fluxes such that they satisfy steady-state constraints.
This gives a model with the fixed variables of $x$ determined by free varaiables:
\begin{align}
    v &= S_m\cdot x\\
\end{align}
This requires modified priors
\begin{align}
    \bv_\Pi^{fr} ~ N(\mathbf{\mu_{v_{\Pi}}}, \Sigma_{v_{\Pi}}) \\
    \bc^{fi} ~ LN(\mathbf{\mu_c}, \Sigma_c) \\
    \bc^{fr} ~ LN(\mathbf{\mu_c}, \Sigma_c) \\
\end{align}
for the model.
The prior for $\bc$ is interesting in that $\bc^{fi}$ are not true parameters of the model.
This means that the prior on $\bc^{fr}$ is in fact an (inadmissable) combination of the direct prior and a transfomration of the transformed second prior on $\bc^{fi}$.
This is further complicated by the fact that, as this is a transformation of paramters, a jacobian transformation should be included to account for the "stretching" of the parameter space by this transformation.
In Section \ref{sec:x_prior} we show that this had no effect in practice and simplcity of formulation was preferred over any theoretical concerns.
%TODO: The above prior is not "inadmissible" - there is another word for it
% TODO: Should I also have a prior on the fixed exchange fluxes?
% TODO: Make a table of the full models with likelihood and prior
% TODO: Redundant rows (Does this change the final equation if the inverse is used?)
% TODO: Mention that S transforms fluxes to changes in met concentrations at the top
% TODO: Which law of thermodynamics?
%TODO: Is dgr_m a nice symbol for the membrane potential? What do others use?


\subsubsection{Membrane potentials}
% TODO: HOW ARE MEMBRANE POTENTIALS CALCULATED?
The final aspect that needs to be included into the model is the addition of membrane potentials for intercompartmental reactions.
This manifests itself as a single value that must be added to the $dgr$ of each reaction.
This requires $S_v$ and $x$ to be slightly refactored.
$S_v$ now includes an extra first column that contains the membrane potentials $\dgr_m \in \mathbb{R}^p$ and $x$ a first entry with the value $1$.
This gives
\[
    S_v = \begin{bmatrix}
              \mathbf{0} & \mathbf{I^p} & \mathbf{0} \\
              \dgr_m & \mathbf{0} & S_{\Gamma}^T\\
          \end{bmatrix} \\
    x = \begin{bmatrix}
            1 \\
            \bv_\Pi \\
            \bsdgf + RT\ln{\bc} \\ %TODO: Replace with \bdgf?
        \end{bmatrix}
\]
leaving all other values unchanged.
% TODO: Does this actually work? Definitely not guaranteed! I actually think it does. Just another driving force.


% TODO: Membrane potential will need to be included


% Mention MCMC




\subsection{Estimation of $\sdgf$} \label{sec:sdgf_estimation}
\subsubsection{Rank degenerate covariance matrix and Cholesky decomposition}

\subsection{GTFA formulation}

\subsubsection{$\sdgf$ priors and change of variables}


% Flux, b and dgr are LINEAR functions of one another

\subsubsection{}

\subsection{Datasets}

\subsubsection{Toy example}

\subsubsection{Gollub dataset}
% Need more info here

% Results and Discussion can be combined.
\section*{Results}

\subsection{Prior on elements of $x$}
\label{sec:x_prior}

\subsection{The effect of change of variables}

\subsection{Speed comparison}

\subsection{}

\section*{Discussion}

% Order of x (and S) in assigning fixed and free varaiables.

% The S_m matrix changes with every proposal. It's possible to use symbolic algebra if we wanted to speed it up.



% GTFA in the context of a pre-processing step before kinetic modelling
% We are trying to unify many sources of information.
% If we represent the results with (eg) a normal distribution, why not use variational inferece?
%

\subsection{Future work}
% Could gtfa work without fluxomics data - i.e. to predict fluxes?
% Inclusion of fluxomics data directly - forward and reverse data
% Inclusion of predictive model into bayesian model? Can you develop a machine learning method of learning latent paramters?
%
% Proper formulation of the prior for x

% Membrane potentials should be included into the model.

\section*{Conclusion}

% TODO: Remove this eventually
\bibliography{bibliography}

\section*{Supporting information}

% Include only the SI item label in the paragraph heading. Use the \nameref{label} command to cite SI items in the text.
%\paragraph*{S1 Fig.}
%\label{S1_Fig}
%{\bf Bold the title sentence.} Add descriptive text after the title of the item (optional).

\section*{Acknowledgments}

\nolinenumbers

% Either type in your references using
% \begin{thebibliography}{}
% \bibitem{}
% Text
% \end{thebibliography}
%
% or
%
% Compile your BiBTeX database using our plos2015.bst
% style file and paste the contents of your .bbl file
% here. See http://journals.plos.org/plosone/s/latex for
% step-by-step instructions.



\end{document}

%------------------------------------------------------------------------------------------------------------------------
% EXAMPLES
% Place figure captions after the first paragraph in which they are cited.
%\begin{figure}[!h]
%\caption{{\bf Bold the figure title.}
%Figure caption text here, please use this space for the figure panel descriptions instead of using subfigure commands. A: Lorem ipsum dolor sit amet. B: Consectetur adipiscing elit.}
%\label{fig1}
%\end{figure}
%% For figure citations, please use "Fig" instead of "Figure".
%
%
%% Place tables after the first paragraph in which they are cited.
%\begin{table}[!ht]
%\begin{adjustwidth}{-2.25in}{0in} % Comment out/remove adjustwidth environment if table fits in text column.
%\centering
%\caption{
%{\bf Table caption Nulla mi mi, venenatis sed ipsum varius, volutpat euismod diam.}}
%\begin{tabular}{|l+l|l|l|l|l|l|l|}
%\hline
%\multicolumn{4}{|l|}{\bf Heading1} & \multicolumn{4}{|l|}{\bf Heading2}\\ \thickhline
%$cell1 row1$ & cell2 row 1 & cell3 row 1 & cell4 row 1 & cell5 row 1 & cell6 row 1 & cell7 row 1 & cell8 row 1\\ \hline
%$cell1 row2$ & cell2 row 2 & cell3 row 2 & cell4 row 2 & cell5 row 2 & cell6 row 2 & cell7 row 2 & cell8 row 2\\ \hline
%$cell1 row3$ & cell2 row 3 & cell3 row 3 & cell4 row 3 & cell5 row 3 & cell6 row 3 & cell7 row 3 & cell8 row 3\\ \hline
%\end{tabular}
%\begin{flushleft} Table notes Phasellus venenatis, tortor nec vestibulum mattis, massa tortor interdum felis, nec pellentesque metus tortor nec nisl. Ut ornare mauris tellus, vel dapibus arcu suscipit sed.
%\end{flushleft}
%\label{table1}
%\end{adjustwidth}
%\end{table}